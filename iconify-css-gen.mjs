import { promises as fs } from 'fs'
import { join, basename } from 'path'
import { parseSVGContent } from '@iconify/utils/lib/svg/parse.mjs'
import { iconToSVG } from '@iconify/utils/lib/svg/build.mjs'

const ICONS_DIR = 'icons'
const OUTPUT_JSON = 'iconify-icons.json'
const OUTPUT_CSS = 'iconify-icons.css'
const CSS_PREFIX = 'iconify'

// å°†SVGå†…å®¹è½¬æ¢ä¸ºbase64ç¼–ç çš„Data URL
function svgToDataUrl(svgContent) {
  // æ¸…ç†SVGå†…å®¹ - ç§»é™¤ä¸å¿…è¦çš„ç©ºç™½å’Œå±æ€§
  const cleanedSvg = svgContent
    .replace(/>\s+</g, '><') // ç§»é™¤æ ‡ç­¾é—´çš„ç©ºç™½
    .replace(/\s+/g, ' ') // å‹ç¼©è¿ç»­ç©ºç™½
    .trim()
  
  // å°è¯•UTF-8ç¼–ç ï¼Œå¦‚æœå¤ªé•¿åˆ™ä½¿ç”¨base64
  const utf8Url = `data:image/svg+xml;utf8,${encodeURIComponent(cleanedSvg)}`
  
  // å¦‚æœURLå¤ªé•¿ï¼ˆè¶…è¿‡8000å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨base64ç¼–ç 
  if (utf8Url.length > 8000) {
    const base64 = Buffer.from(cleanedSvg, 'utf8').toString('base64')
    return `data:image/svg+xml;base64,${base64}`
  }
  
  return utf8Url
}

// 1. è¯»å–æ‰€æœ‰ svg æ–‡ä»¶
const files = (await fs.readdir(ICONS_DIR)).filter(f => f.endsWith('.svg'))
const iconSet = {
  prefix: 'myicon',
  icons: {},
  width: 24,
  height: 24
}

for (const file of files) {
  const svgRaw = await fs.readFile(join(ICONS_DIR, file), 'utf-8')
  // 2. ä¿æŒåŸå§‹é¢œè‰²ï¼Œä¸æ›¿æ¢ä¸ºcurrentColor
  const svg = svgRaw
  // 3. è§£æ SVG
  const parsed = parseSVGContent(svg)
  if (!parsed) continue
  // 4. ç»„è£… icon setï¼Œæ–‡ä»¶åè½¬ä¸‹åˆ’çº¿
  let name = basename(file, '.svg').replace(/[^a-zA-Z0-9_-]/g, '_')
  iconSet.icons[name] = {
    body: parsed.body,
    width: parsed.width || 24,
    height: parsed.height || 24,
    viewBox: parsed.viewBox || '0 0 24 24'
  }
}

// 5. ç”Ÿæˆ JSON æ–‡ä»¶
await fs.writeFile(OUTPUT_JSON, JSON.stringify(iconSet, null, 2))

// 6. ç”Ÿæˆ CSS æ–‡ä»¶
let cssContent = '/* Generated by iconify-css-gen.mjs - Colored Icons */\n'
cssContent += '.iconify { display: inline-block; width: 1em; height: 1em; vertical-align: -0.125em; background-repeat: no-repeat; background-position: center; background-size: contain; }\n'

for (const file of files) {
  const svgRaw = await fs.readFile(join(ICONS_DIR, file), 'utf-8')
  // ä¿æŒåŸå§‹é¢œè‰²çš„SVG
  const svg = svgRaw
  
  // æ–‡ä»¶åè½¬CSSç±»å
  let name = basename(file, '.svg').replace(/[^a-zA-Z0-9_-]/g, '_')
  
  // ç”Ÿæˆä¼˜åŒ–çš„data URL
  const dataUrl = svgToDataUrl(svg)
  
  cssContent += `.${CSS_PREFIX}-${name} { background-image: url('${dataUrl}'); }\n`
}

await fs.writeFile(OUTPUT_CSS, cssContent)

console.log(`âœ… Generated ${files.length} colored icons`)
console.log(`ğŸ“„ JSON: ${OUTPUT_JSON}`)
console.log(`ğŸ¨ CSS: ${OUTPUT_CSS}`) 
